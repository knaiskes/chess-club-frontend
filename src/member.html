<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Member Details</title>
    <link rel="stylesheet" href="../dist/style.css">
    <script src="../node_modules/alpinejs/dist/cdn.js" defer></script>
    <style>
      [x-cloak] {
        display: none !important;
      }
    </style>
  </head>
  <body x-data="memberDetails()" x-init="init()" x-cloak>
    <div x-ref="navbar"></div>
    <div class="flex items-center justify-center">
      <template x-if="hasPhoto()">
        <img class="w-10 h-10 p-1 rounded-full ring-2 ring-gray-100 dark:ring-gray-300" :src="member.profile_photo_url" alt="memberInitials()">
      </template>
      <template x-if="!hasPhoto()">
        <div class="relative inline-flex items-center justify-center w-10 h-10 overflow-hidden bg-gray-100 rounded-full dark:bg-gray-600">
          <span class="font-medium text-gray-600 dark:text-gray-300" x-text="memberInitials()"></span>
        </div>
      </template>
      <h4 class="ml-4 text-4xl font-extrabold leading-none tracking-tight text-gray-900 md:text-5xl lg:text-6xl dark:text-gray flex items-center mb-4" x-text="`${member.firstname} ${member.lastname}`"></h4>
    </div>
    
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200 border-collapse">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs uppercase tracking-wider">First Name</th>
            <th class="px-6 py-3 text-left text-xs uppercase tracking-wider">Last Name</th>
            <th class="px-6 py-3 text-left text-xs uppercase tracking-wider">Age</th>
            <th class="px-6 py-3 text-left text-xs uppercase tracking-wider">Gender</th>
            <th class="px-6 py-3 text-left text-xs uppercase tracking-wider">Email</th>
            <th class="px-6 py-3 text-left text-xs tracking-wider">Is Active</th>
            <th class="px-6 py-3 text-left text-xs uppercase tracking-wider">FIDE Rating</th>
            <th class="px-6 py-3 text-left text-xs uppercase tracking-wider">Overdue Subscription</th>
            <th class="px-6 py-3 text-left text-xs uppercase tracking-wider">Lichess Profile</th>
            <th class="px-6 py-3 text-left text-xs uppercase tracking-wider">Chess.com Profile</th>
            <th class="px-6 py-3 text-left text-xs uppercase tracking-wider">FIDE Profile</th>
            <th class="px-6 py-3 text-left text-xs uppercase tracking-wider">Joined At</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <tr class="hover:bg-gray-100">
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="member.firstname"></td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="member.lastname"></td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="member.age"></td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="member.gender"></td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="member.email"></td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="member.is_active ? '&#10004;' : '&#x2715;'" :class="member.is_active ? 'text-green-500' : 'text-red-500'"></td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="member.fide_rating !== null ? member.fide_rating : 'N/A'"></td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="member.overdue_subscription ? 'Yes' : 'No'"></td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="member.lichess_profile !== null ? member.lichess_profile : 'N/A'"></td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="member.chesscom_profile !== null ? member.chesscom_profile : 'N/A'"></td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="member.fide_profile !== null ? member.fide_profile : 'N/A'"></td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="new Date(member.joined_at).toDateString()"></td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <button @click="openModal()" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Edit Member</button>
    
    <div x-show="isModalOpen" @click.away="closeModal()" x-cloak class="fixed inset-0 flex items-center justify-center z-50">
      <div class="bg-white p-6 rounded-lg shadow-lg w-96">
        <h2 class="text-2xl font-bold mb-4">Edit Member</h2>
        
        <div class="mb-4">
          <label class="block text-gray-700">First Name</label>
          <input type="text" x-model="member.firstname" class="w-full px-3 py-2 border rounded" />
        </div>
        
        <div class="mb-4">
          <label class="block text-gray-700">Last Name</label>
          <input type="text" x-model="member.lastname" class="w-full px-3 py-2 border rounded" />
        </div>
        
        <div class="mb-4">
          <label class="block text-gray-700">Email</label>
          <input type="email" x-model="member.email" class="w-full px-3 py-2 border rounded" />
        </div>

	<div class="mb-4">
          <label class="block text-gray-700">Is Active</label>
          <input type="checkbox" x-model="member.is_active" class="w-full px-3 py-2 border rounded" />
        </div>

	<div class="mb-4">
          <label class="block text-gray-700">Age</label>
          <input type="number" x-model="member.age" class="w-full px-3 py-2 border rounded" />
        </div>

	<div class="mb-4">
          <label class="block text-gray-700">Fide Rating</label>
          <input type="number" x-model="member.fide_rating" class="w-full px-3 py-2 border rounded" />
        </div>

	<div class="mb-4">
          <label class="block text-gray-700">Overdue Subscription</label>
          <input type="checkbox" x-model="member.overdue_subscription" class="w-full px-3 py-2 border rounded" />
        </div>

	<div class="mb-4">
          <label class="block text-gray-700">Lichess Profile</label>
          <input type="text" x-model="member.lichess_profile" class="w-full px-3 py-2 border rounded" />
        </div>

	<div class="mb-4">
          <label class="block text-gray-700">Chess.com Profile</label>
          <input type="text" x-model="member.chesscom_profile" class="w-full px-3 py-2 border rounded" />
        </div>

	<div class="mb-4">
          <label class="block text-gray-700">Fide Profile</label>
          <input type="text" x-model="member.fide_profile" class="w-full px-3 py-2 border rounded" />
        </div>
        
        <div class="flex justify-end">
          <button @click="closeModal()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 mr-2">Cancel</button>
          <button @click="saveChanges()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Save</button>
        </div>
      </div>
    </div>
    
    <script>
      function memberDetails() {
        return {
          member: [],
          isModalOpen: false,
          
          async init() {
            await this.fetchMemberDetails();
          },
          
          async fetchMemberDetails() {
            const token = localStorage.getItem('chess_club_token');
            if (!token) {
              window.location.href = 'login.html';
            } else {
              try {
                const urlParams = new URLSearchParams(window.location.search);
                const memberId = urlParams.get('id');
                const response = await fetch(`http://localhost:3000/api/v1/members/${memberId}`, {
                  method: 'GET',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                  }
                });
                const data = await response.json();
                this.member = data;
              } catch (error) {
                console.error('Error fetching member details:', error);
              }
            }
          },

	  hasPhoto() {
	    return this.profile_photo_url;
	  },

	  memberInitials() {
	    return this.member.firstname && this.member.lastname ? `${this.member.firstname[0]}${this.member.lastname[0]}` : 'AN';
	  },
          
          openModal() {
            this.isModalOpen = true;
          },
          
          closeModal() {
            this.isModalOpen = false;
          },
          
          async saveChanges() {
            try {
              const token = localStorage.getItem('chess_club_token');
              const urlParams = new URLSearchParams(window.location.search);
              const memberId = urlParams.get('id');
              
              const response = await fetch(`http://localhost:3000/api/v1/members/${memberId}`, {
                method: 'PATCH',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(this.member)
              });
              
              if (response.ok) {
                this.closeModal();
                await this.fetchMemberDetails();
              } else {
                console.error('Failed to save changes');
              }
            } catch (error) {
              console.error('Error saving member details:', error);
            }
          }
        }
      }
    </script>
  </body>
</html>
